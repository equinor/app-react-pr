# Extract Package Info Action
# 
# Extracts package information (name, version, path) from git tags and package.json files.
# Supports both monorepo and single-package project structures with automatic detection.
#
# Features:
# - Automatic project structure detection (monorepo vs single-package)
# - Version extraction from git tags (removes refs/tags/v prefix)
# - Package name extraction from package.json
# - Working directory determination for build processes
# - Support for Fusion app detection
#
# Supported Project Structures:
# 1. Monorepo: packages in apps/<package-name>/ directory
# 2. Single package: package.json in root directory
#
# Example usage in workflow:
#
# steps:
#   - name: Extract package info
#     id: package-info
#     uses: ./.github/workflows/actions/extract-package-info
#     with:
#       tag-ref: ${{ github.ref }}        # Optional, defaults to github.ref
#       package-name: my-app              # Required for monorepo
#
#   - name: Build in correct directory
#     working-directory: ${{ steps.package-info.outputs.working-directory }}
#     run: npm run build
#
# Outputs:
# - app-name: Package name from package.json
# - app-version: Version extracted from git tag (v1.2.3 â†’ 1.2.3)
# - app-path: Path to directory containing package.json
# - working-directory: Working directory for package operations
# - project-structure: "monorepo" or "single-package"
#
name: 'Extract Package Info'
description: 'Extracts package name, version, and path from git tag reference'
inputs:
  tag-ref:
    description: 'Git tag reference (e.g., refs/tags/v1.0.0)'
    required: false
    default: ${{ github.ref }}
  package-name:
    description: 'Package name for monorepo structure (optional)'
    required: false
outputs:
  app-name:
    description: 'The extracted package name from package.json'
    value: ${{ steps.extract.outputs.app-name }}
  app-version:
    description: 'The extracted version from the git tag'
    value: ${{ steps.extract.outputs.app-version }}
  app-path:
    description: 'The path to the directory containing package.json'
    value: ${{ steps.extract.outputs.app-path }}
  working-directory:
    description: 'The working directory for the package'
    value: ${{ steps.extract.outputs.working-directory }}
  project-structure:
    description: 'The detected project structure (monorepo or single-package)'
    value: ${{ steps.extract.outputs.project-structure }}
runs:
  using: 'composite'
  steps:
    - name: Extract package information
      id: extract
      shell: bash
      run: |
        echo "Extracting package name and path from tag: ${{ inputs.tag-ref }}"
        
        # Extract version from tag (remove refs/tags/v prefix)
        PACKAGE_VERSION=$(echo "${{ inputs.tag-ref }}" | sed 's|refs/tags/v||')
        echo "Extracted version: $PACKAGE_VERSION"
        
        # Detect project structure and set working directory
        WORKING_DIR=""
        PROJECT_STRUCTURE=""
        
        if [ -n "${{ inputs.package-name }}" ] && [ -d "apps/${{ inputs.package-name }}" ]; then
          WORKING_DIR="apps/${{ inputs.package-name }}"
          PROJECT_STRUCTURE="monorepo"
          echo "working-directory=$WORKING_DIR" >> $GITHUB_OUTPUT
          echo "project-structure=$PROJECT_STRUCTURE" >> $GITHUB_OUTPUT
          echo "Project structure: Monorepo (apps/${{ inputs.package-name }})"
        elif [ -f "package.json" ]; then
          WORKING_DIR="."
          PROJECT_STRUCTURE="single-package"
          echo "working-directory=$WORKING_DIR" >> $GITHUB_OUTPUT
          echo "project-structure=$PROJECT_STRUCTURE" >> $GITHUB_OUTPUT
          if [ -f "app.manifest.ts" ]; then
            echo "Project structure: Single package (root directory) - Fusion app detected"
          else
            echo "Project structure: Single package (root directory) - Generic package"
          fi
        else
          echo "Error: Could not detect project structure"
          echo "- For monorepo: Provide package-name input and ensure apps/\$package-name directory exists"
          echo "- For single package: Ensure package.json exists in root directory"
          exit 1
        fi
        
        # Find package.json in the detected working directory
        if [ "$WORKING_DIR" = "." ]; then
          PACKAGE_JSON_PATH="./package.json"
        else
          PACKAGE_JSON_PATH="$WORKING_DIR/package.json"
        fi
        
        if [ -f "$PACKAGE_JSON_PATH" ]; then
          echo "Found package.json at: $PACKAGE_JSON_PATH"
          
          # Extract package name from package.json
          PACKAGE_NAME=$(grep -o '"name": *"[^"]*"' "$PACKAGE_JSON_PATH" | cut -d'"' -f4)
          PATH_TO_PACKAGE=$(dirname "$PACKAGE_JSON_PATH")
          
          echo "Package name: $PACKAGE_NAME"
          echo "Package version: $PACKAGE_VERSION"
          echo "Package path: $PATH_TO_PACKAGE"
          
          # Set outputs
          echo "app-name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "app-version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "app-path=$PATH_TO_PACKAGE" >> $GITHUB_OUTPUT
        else
          echo "Error: No package.json found at expected path: $PACKAGE_JSON_PATH"
          exit 1
        fi