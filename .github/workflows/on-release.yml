name: ðŸš€ On release

on:
  workflow_run:
    workflows: ["ðŸš€ CI Application"]
    types:
      - completed
    branches:
      - main

jobs:
  extract-package:
    runs-on: ubuntu-latest
    # Only run if the workflow was successful and a release was published
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
        appName: ${{ steps.extract.outputs.appName }}
        appPath: ${{ steps.extract.outputs.appPath }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Get latest release
        id: latest_release
        run: |
          # Get the latest release created by the CI workflow
          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          echo "Latest tag: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract package name and path
        id: extract
        run: |
              echo "Extracting package name and path from tag: ${{ steps.latest_release.outputs.tag }}"
              PACKAGE_NAME=$(echo ${{ steps.latest_release.outputs.tag }} | cut -d'@' -f1)
              PACKAGE_VERSION=$(echo ${{ steps.latest_release.outputs.tag }} | cut -d'@' -f2)
              PATH_TO_PACKAGE=$(find . -type f -name "package.json" -exec grep -l "\"name\": \"${PACKAGE_NAME}\"" {} + | head -n 1 | xargs dirname)
               
              echo "appName=$PACKAGE_NAME" >> $GITHUB_OUTPUT
              echo "appPath=$PATH_TO_PACKAGE" >> $GITHUB_OUTPUT
        

  build:
    needs: extract-package
    # Only run if extract-package job was successful
    if: ${{ needs.extract-package.result == 'success' }}
    secrets: inherit
    uses: ./.github/workflows/build.yml
    permissions:
      contents: read
      id-token: write
      issues: write
      pull-requests: write
    with:
        app-name: ${{ needs.extract-package.outputs.appName }}
        work-dir: ${{ needs.extract-package.outputs.appPath }}
        env-matrix: '["ci"]' # if needed add additinal environments '["ci", "fqa", "fprd", "tr"]'


