name: ðŸš€ On release

on:
  release:
    types:
      - published

jobs:
  extract-package:
    runs-on: ubuntu-latest
    outputs:
        appName: ${{ steps.extract.outputs.appName }}
        appPath: ${{ steps.extract.outputs.appPath }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Extract package name and path
        id: extract
        run: |
              echo "Extracting package name and path from tag: ${{ github.ref }}"
              PACKAGE_NAME=$(echo ${{ github.ref }} | cut -d'@' -f1 | sed 's|refs/tags/||')
              PACKAGE_VERSION=$(echo ${{ github.ref }} | cut -d'@' -f2)
              PATH_TO_PACKAGE=$(find . -type f -name "package.json" -exec grep -l "\"name\": \"${PACKAGE_NAME}\"" {} + | head -n 1 | xargs dirname)
               
              echo "appName=$PACKAGE_NAME" >> $GITHUB_OUTPUT
              echo "appPath=$PATH_TO_PACKAGE" >> $GITHUB_OUTPUT
        

  build:
    needs: extract-package
    secrets: inherit
    uses: ./.github/workflows/build.yml
    permissions:
      contents: read
      id-token: write
      issues: write
      pull-requests: write
    with:
        app-name: ${{ needs.extract-package.outputs.appName }}
        work-dir: ${{ needs.extract-package.outputs.appPath }}
        env-matrix: '["ci"]' # if needed add additinal environments '["ci", "fqa", "fprd", "tr"]'


