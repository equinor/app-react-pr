name: ğŸ› ï¸ PR

# The permissions the workflow needs to run
# - id-token: Required for OpenID Connect authentication with Azure
# - contents: Required to read the repository contents during checkout
# - pull-requests: Required for the publish action to read/write comments on the PR
permissions:
  id-token: write
  contents: read
  pull-requests: write

on:
  pull_request:
    types:
      - ready_for_review
      - opened
      - reopened
      - synchronize

concurrency:
  group: pr-${{ github.event.pull_request.id }}
  cancel-in-progress: true

jobs:
  pr-detection:
    name: ğŸ•µï¸â€â™‚ï¸ PR Draft Detection 
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      is-draft: ${{ steps.check-draft.outputs.is-draft }}
    steps:
    
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check if Draft
        uses: ./.github/workflows/actions/check-draft
        id: check-draft
        with:
          pr-number: ${{ github.event.pull_request.number }}

      - name: Add draft status to summary
        run: |
          if [ "${{ steps.check-draft.outputs.is-draft }}" = "true" ]; then
            echo "## âš ï¸ Draft Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "This PR is currently in draft status. Now running validation workflow." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Ready for Review" >> $GITHUB_STEP_SUMMARY
            echo "This PR is ready for review. Running full PR pipeline." >> $GITHUB_STEP_SUMMARY
          fi
          

  build:
    name: ğŸ› ï¸ App Resolver Workflow
    needs: pr-detection
    if: needs.pr-detection.outputs.is-draft == 'false' && github.actor != 'dependabot[bot]' 
    permissions:
      contents: read
      id-token: write
      issues: write
      pull-requests: write
    uses: ./.github/workflows/app-resolver.yml


  lint-validation:
    name: ğŸ§¹ Lint Validation
    needs: pr-detection
    if: needs.pr-detection.outputs.is-draft == 'true'
    permissions:
      contents: read
      pull-requests: write
      checks: write
    uses: ./.github/workflows/lint-validation.yml
  
  test-validation:
    name: ğŸ§ª Test Validation
    needs: pr-detection
    if: needs.pr-detection.outputs.is-draft == 'true'
    permissions:
      contents: read
      pull-requests: write
      checks: write
    uses: ./.github/workflows/test-validation.yml
    

